<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Analytics Dashboard - AI Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
    }

    .auth-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .auth-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .auth-section button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .auth-section button:hover {
      background: #5568d3;
    }

    .auth-section button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters label {
      font-weight: 600;
      color: #666;
    }

    .filters input, .filters select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .filters button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .filters button:hover {
      background: #5568d3;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-card .subtitle {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .chart-card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    table tr:hover {
      background: #f9f9f9;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .hidden {
      display: none;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-buttons button {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-buttons button.active {
      background: #667eea;
      color: white;
    }

    .tab-buttons button:hover {
      background: #667eea;
      color: white;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>API Analytics Dashboard</h1>
      <p>Monitor API usage, performance, and track endpoint statistics</p>
    </div>

    <div id="authSection" class="auth-section">
      <h3>Authentication Required</h3>
      <p style="margin-bottom: 15px; color: #666;">Enter your Firebase ID token to access analytics</p>
      <input type="password" id="tokenInput" placeholder="Firebase ID Token" />
      <button onclick="authenticate()">Login</button>
    </div>

    <div id="dashboard" class="hidden">
      <div class="filters">
        <div>
          <label>Time Range:</label>
          <select id="timeRange" onchange="loadAllData()">
            <option value="1h">Last Hour</option>
            <option value="24h" selected>Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="customDates" class="hidden">
          <input type="datetime-local" id="startDate" />
          <input type="datetime-local" id="endDate" />
        </div>
        <button onclick="loadAllData()">Refresh</button>
        <button onclick="logout()" style="background: #e74c3c;">Logout</button>
      </div>

      <div id="errorMessage" class="error-message hidden"></div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Total Requests</h3>
          <div class="value" id="totalRequests">-</div>
          <div class="subtitle" id="dateRange">-</div>
        </div>
        <div class="stat-card">
          <h3>Error Rate</h3>
          <div class="value" id="errorRate">-</div>
          <div class="subtitle"><span id="totalErrors">-</span> errors</div>
        </div>
        <div class="stat-card">
          <h3>Avg Response Time</h3>
          <div class="value" id="avgResponseTime">-</div>
          <div class="subtitle">milliseconds</div>
        </div>
        <div class="stat-card">
          <h3>Unique Users</h3>
          <div class="value" id="uniqueUsers">-</div>
          <div class="subtitle">active users</div>
        </div>
        <div class="stat-card">
          <h3>Unique Endpoints</h3>
          <div class="value" id="uniqueEndpoints">-</div>
          <div class="subtitle">API endpoints</div>
        </div>
      </div>

      <div class="tab-buttons">
        <button class="active" onclick="showTab('endpoints')">Endpoints</button>
        <button onclick="showTab('users')">Users</button>
        <button onclick="showTab('performance')">Performance</button>
        <button onclick="showTab('errors')">Errors</button>
      </div>

      <div id="endpointsTab" class="chart-card">
        <h2>Endpoint Usage</h2>
        <div id="endpointsTable"></div>
      </div>

      <div id="usersTab" class="chart-card hidden">
        <h2>User Activity</h2>
        <div id="usersTable"></div>
      </div>

      <div id="performanceTab" class="chart-card hidden">
        <h2>Performance Metrics</h2>
        <div id="performanceTable"></div>
      </div>

      <div id="errorsTab" class="chart-card hidden">
        <h2>Recent Errors</h2>
        <div id="errorsTable"></div>
      </div>
    </div>

    <div id="loading" class="loading">Loading analytics data...</div>
  </div>

  <script>
    const BASE_PATH = window.location.pathname.includes('/ai-dashboard') ? '/ai-dashboard' : '';
    const API_BASE = window.location.origin + BASE_PATH;
    let authToken = localStorage.getItem('analyticsToken');
    let currentTab = 'endpoints';

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      if (authToken) {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        loadAllData();
      } else {
        document.getElementById('loading').classList.add('hidden');
      }

      // Time range selector
      document.getElementById('timeRange').addEventListener('change', (e) => {
        if (e.target.value === 'custom') {
          document.getElementById('customDates').classList.remove('hidden');
        } else {
          document.getElementById('customDates').classList.add('hidden');
        }
      });
    });

    async function authenticate() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        alert('Please enter your Firebase ID token');
        return;
      }

      authToken = token;
      localStorage.setItem('analyticsToken', token);

      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      loadAllData();
    }

    function logout() {
      authToken = null;
      localStorage.removeItem('analyticsToken');
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('tokenInput').value = '';
    }

    function showTab(tab) {
      currentTab = tab;
      // Update button states
      document.querySelectorAll('.tab-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide tabs
      document.getElementById('endpointsTab').classList.add('hidden');
      document.getElementById('usersTab').classList.add('hidden');
      document.getElementById('performanceTab').classList.add('hidden');
      document.getElementById('errorsTab').classList.add('hidden');
      document.getElementById(tab + 'Tab').classList.remove('hidden');
    }

    function getDateRange() {
      const range = document.getElementById('timeRange').value;
      const now = new Date();
      let startDate;

      switch (range) {
        case '1h':
          startDate = new Date(now - 60 * 60 * 1000);
          break;
        case '24h':
          startDate = new Date(now - 24 * 60 * 60 * 1000);
          break;
        case '7d':
          startDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
          break;
        case '30d':
          startDate = new Date(now - 30 * 24 * 60 * 60 * 1000);
          break;
        case 'custom':
          const startInput = document.getElementById('startDate').value;
          const endInput = document.getElementById('endDate').value;
          return {
            startDate: startInput ? new Date(startInput).toISOString() : null,
            endDate: endInput ? new Date(endInput).toISOString() : now.toISOString(),
          };
        default:
          startDate = new Date(now - 24 * 60 * 60 * 1000);
      }

      return {
        startDate: startDate.toISOString(),
        endDate: now.toISOString(),
      };
    }

    async function fetchAPI(endpoint, params = {}) {
      const queryString = new URLSearchParams(params).toString();
      const url = `${API_BASE}/api/analytics/${endpoint}${queryString ? '?' + queryString : ''}`;

      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json',
        },
      });

      if (response.status === 401 || response.status === 403) {
        logout();
        throw new Error('Authentication failed. Please login again.');
      }

      if (!response.ok) {
        throw new Error(`Failed to fetch ${endpoint}`);
      }

      return await response.json();
    }

    async function loadAllData() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('errorMessage').classList.add('hidden');

      try {
        const dateRange = getDateRange();

        // Load dashboard stats
        const stats = await fetchAPI('dashboard', dateRange);
        updateDashboardStats(stats.data);

        // Load endpoint data
        const endpoints = await fetchAPI('endpoints', dateRange);
        updateEndpointsTable(endpoints.data);

        // Load user data
        const users = await fetchAPI('users', dateRange);
        updateUsersTable(users.data);

        // Load performance data
        const performance = await fetchAPI('performance', dateRange);
        updatePerformanceTable(performance.data);

        // Load error logs
        const errors = await fetchAPI('errors', dateRange);
        updateErrorsTable(errors.data);

      } catch (error) {
        showError(error.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function updateDashboardStats(data) {
      document.getElementById('totalRequests').textContent = data.totalRequests.toLocaleString();
      document.getElementById('errorRate').textContent = data.errorRate;
      document.getElementById('totalErrors').textContent = data.totalErrors.toLocaleString();
      document.getElementById('avgResponseTime').textContent = data.avgResponseTime + 'ms';
      document.getElementById('uniqueUsers').textContent = data.uniqueUsers.toLocaleString();
      document.getElementById('uniqueEndpoints').textContent = data.uniqueEndpoints.toLocaleString();

      const start = new Date(data.dateRange.start || Date.now() - 24*60*60*1000);
      const end = new Date(data.dateRange.end);
      document.getElementById('dateRange').textContent =
        `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
    }

    function updateEndpointsTable(data) {
      const html = `
        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Total Calls</th>
              <th>Success</th>
              <th>Errors</th>
              <th>Error Rate</th>
              <th>Avg Response</th>
              <th>Methods</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td><strong>${row.endpoint}</strong></td>
                <td>${row.totalCalls.toLocaleString()}</td>
                <td>${row.successCount.toLocaleString()}</td>
                <td>${row.errorCount.toLocaleString()}</td>
                <td><span class="badge ${row.errorCount > 0 ? 'error' : 'success'}">${row.errorRate}</span></td>
                <td>${row.avgResponseTime}ms</td>
                <td>${Object.entries(row.methods).map(([k,v]) => `${k}:${v}`).join(', ')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('endpointsTable').innerHTML = html;
    }

    function updateUsersTable(data) {
      const html = `
        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Company</th>
              <th>Role</th>
              <th>Total Requests</th>
              <th>Unique Endpoints</th>
              <th>Last Active</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td><strong>${row.userId}</strong></td>
                <td>${row.companyName || 'N/A'}</td>
                <td>${row.role || 'N/A'}</td>
                <td>${row.totalRequests.toLocaleString()}</td>
                <td>${row.uniqueEndpoints}</td>
                <td>${new Date(row.lastActive).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('usersTable').innerHTML = html;
    }

    function updatePerformanceTable(data) {
      const html = `
        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Calls</th>
              <th>Avg</th>
              <th>Min</th>
              <th>Max</th>
              <th>P50</th>
              <th>P95</th>
              <th>P99</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td><strong>${row.endpoint}</strong></td>
                <td>${row.calls.toLocaleString()}</td>
                <td>${row.avgResponseTime}ms</td>
                <td>${row.minResponseTime}ms</td>
                <td>${row.maxResponseTime}ms</td>
                <td>${row.p50ResponseTime}ms</td>
                <td>${row.p95ResponseTime}ms</td>
                <td>${row.p99ResponseTime}ms</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('performanceTable').innerHTML = html;
    }

    function updateErrorsTable(data) {
      const html = `
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Endpoint</th>
              <th>Method</th>
              <th>Status</th>
              <th>User</th>
              <th>Response Time</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td>${new Date(row.timestamp).toLocaleString()}</td>
                <td><strong>${row.endpoint}</strong></td>
                <td>${row.method}</td>
                <td><span class="badge error">${row.statusCode}</span></td>
                <td>${row.userId || 'Anonymous'}</td>
                <td>${row.responseTime}ms</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('errorsTable').innerHTML = html;
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
  </script>
</body>
</html>
